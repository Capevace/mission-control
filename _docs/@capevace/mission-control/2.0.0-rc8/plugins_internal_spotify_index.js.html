<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: plugins/internal/spotify/index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: plugins/internal/spotify/index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*global Buffer */
const config = require('@config');
const database = require('@database');
const state = require('@state');
const logger = require('@helpers/logger').createLogger('Spotify', 'greenBright');

const superagent = require('superagent');

const makeAPI = require('./api');
const routes = require('./routes');

module.exports = function spotifyInit(APP) {
	const { state, database, logger, config, http } = APP;
	const API = makeAPI(APP);

	const spotifyData = database.get('spotify', {});
	

	/**
	 * @ACTION
	 * Update the Spotify access token thats saved in the database and state.
	 *
	 * @constant SPOTIFY:UPDATE-TOKEN
	 * @property {string} accessToken The access token to update.
	 * @property {Date} expiresAt The date the access token expires at.
	 * @property {string} refreshToken The token to request a new access token with.
	 * @example demo-action-call
	 */
	state.addAction(
		'SPOTIFY:UPDATE-TOKEN', 
		API.updateTokenState, 
		API.validateTokenUpdate
	);

	state.subscribe('spotify:callback', async ({ code }) => {
		logger.debug('Requesting access token from Spotify.');

		try {
			const data = await API.requestAccessToken(code);
			API.authorizeSpotify(
				data.accessToken,
				data.expiresAt,
				data.refreshToken
			);
		} catch (e) {
			logger.error('Couldnt request access token.', e);
		}
	});

	// If Spotify isnt authorized, we cant use it.
	if (!spotifyData.accessToken) {
		logger.warn(
			`Spotify isnt authorized. Visit ${require('chalk').cyan(
				`${config.http.url}/spotify/auth`
			)} and log in.`
		);
	} else {
		const expiresAt = new Date(spotifyData.expiresAt);
		const now = new Date();

		// Get a new token, if the old one has expired.
		// If not, set a timeout to get a new token ahead of time.
		if (expiresAt &lt;= now) {
			logger.debug('Access token has expired. Requesting new token.');

			API.scheduleTokenRefresh(new Date(), spotifyData.refreshToken);
		} else {
			logger.debug(`Access token is still fresh.`);
			API.authorizeSpotify(
				spotifyData.accessToken,
				new Date(spotifyData.expiresAt),
				spotifyData.refreshToken
			);
		}
	}

	// Register Page component
	http.addComponentFile('spotify-page', __dirname + '/spotify-page.html');

	// Register Page in Vue Router
	http.addPage('/spotify', 'Spotify', 'spotify-page', { icon: 'spotify-icon', menu: 200 });

	// Register HTTP routes
	routes(APP);

	return {
		version: '0.0.1',
		description: 'A built in Spotify player'
	};
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-@config.html">@config</a></li><li><a href="module-@database.html">@database</a></li><li><a href="module-@helpers_log.html">@helpers/log</a></li><li><a href="module-@http.html">@http</a></li><li><a href="module-@socket.html">@socket</a></li><li><a href="module-@state.html">@state</a></li><li><a href="module-@state_actions.html">@state/actions</a></li><li><a href="module-@state_initial-state.html">@state/initial-state</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-test.html">test</a></li></ul><h3>Global</h3><ul><li><a href="global.html#BAHN:UPDATE">BAHN:UPDATE</a></li><li><a href="global.html#comparePassword">comparePassword</a></li><li><a href="global.html#COVID:UPDATE">COVID:UPDATE</a></li><li><a href="global.html#hashPassword">hashPassword</a></li><li><a href="global.html#hashPasswordSync">hashPasswordSync</a></li><li><a href="global.html#HOMEKIT:SET-INITIALIZED">HOMEKIT:SET-INITIALIZED</a></li><li><a href="global.html#HOMEKIT:SET-SERVICES">HOMEKIT:SET-SERVICES</a></li><li><a href="global.html#LAYOUT:RESET">LAYOUT:RESET</a></li><li><a href="global.html#LAYOUT:UPDATE">LAYOUT:UPDATE</a></li><li><a href="global.html#NOTIFICATIONS:CREATE">NOTIFICATIONS:CREATE</a></li><li><a href="global.html#NOTIFICATIONS:DELETE">NOTIFICATIONS:DELETE</a></li><li><a href="global.html#NOTIFICATIONS:MARK-AS-READ">NOTIFICATIONS:MARK-AS-READ</a></li><li><a href="global.html#NOTIFICATIONS:SET">NOTIFICATIONS:SET</a></li><li><a href="global.html#PLUGINS:ADD">PLUGINS:ADD</a></li><li><a href="global.html#SPOTIFY:UPDATE-TOKEN">SPOTIFY:UPDATE-TOKEN</a></li><li><a href="global.html#SYSTEM-INFO:UPDATE">SYSTEM-INFO:UPDATE</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Sat Apr 24 2021 01:53:25 GMT+0200 (Mitteleurop√§ische Sommerzeit)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
