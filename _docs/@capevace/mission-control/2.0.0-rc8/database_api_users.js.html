<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: database/api/users.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: database/api/users.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const User = require('@database/models/User');
const crypto = require('@helpers/crypto');
const logger = require('@helpers/logger').createLogger('Database', 'magenta');

module.exports = function initAPI(db) {
	const foundUsers = null//db.get('users', null);
	const tempPassword = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);

	// If no users are present, we generate a temporary user account and tell the user in the console
	if (!foundUsers || Object.keys(foundUsers.length)) {
		logger.newLine();
		logger.warn('=========================================================');
		logger.newLine();
		logger.warn('No registered users found in DB!');
		logger.warn(`Enabling admin account 'temp' with password '${tempPassword}'`);
		logger.newLine();
		logger.warn('=========================================================');
		logger.newLine();
	}

	const api = {
		_set: async (users) => db.set('users', users),
		async getAll() {
			return db.get('users', { 'temp': User.composeTempUser(tempPassword) });
		},
		async findUser(username) {
			return (await api.getAll())[username];
		},

		/**
		 * Update the user meta in DB (display name and avatar url).
		 *
		 * This method does NOT allow changing the password.
		 * Only do this with `api.users.updatePassword(&lt;username>, &lt;unhashed-password>)`.
		 *
		 * @param  {string} username Username
		 * @param  {User} user The user object
		 * @return {void}
		 */
		async updateMeta(username, { avatarUrl, displayName }) {
			let users = await api.getUsers();

			if (!users[username])
				throw new Error(`User ${username} could not be found`);

			// Password can not be changed in the update method
			users[username] = User.validate({
				...users[user.username],
				avatarUrl,
				displayName
			});

			await api._set(users);
		},

		/**
		 * Update the user meta in DB (display name and avatar url).
		 *
		 * This method does NOT allow changing the password.
		 * Only do this with `api.users.updatePassword(&lt;username>, &lt;unhashed-password>)`.
		 *
		 * @param  {string} username Username
		 * @param  {User} user The user object
		 * @return {void}
		 */
		async updateUsername(username, newUsername) {
			let users = await api.getUsers();

			if (!users[username])
				throw new Error(`User ${username} could not be found`);

			if (!users[newUsername])
				throw new Error(`Cannot change username. User ${newUsername} already exists.`);

			logger.info(`Changing username from ${username} to ${newUsername}`);

			const newUser = User.validate({
				...users[username],
				username: newUsername
			});

			delete users[username];
			users[newUsername] = newUser;

			await api._set(users);
		},

		/**
		 * Hash a users password and save it to DB.
		 * 
		 * @param  {string} username
		 * @param  {string} password
		 */
		async updatePassword(username, password) {
			let users = await api.getUsers();

			if (!users[username])
				throw new Error(`User ${username} could not be found`);

			users[username] = User.validate({
				...users[username],
				password: crypto.hashPasswordSync(password)
			});

			await api._set(users);
		}
	};

	return api;
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-@config.html">@config</a></li><li><a href="module-@database.html">@database</a></li><li><a href="module-@helpers_log.html">@helpers/log</a></li><li><a href="module-@http.html">@http</a></li><li><a href="module-@socket.html">@socket</a></li><li><a href="module-@state.html">@state</a></li><li><a href="module-@state_actions.html">@state/actions</a></li><li><a href="module-@state_initial-state.html">@state/initial-state</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-test.html">test</a></li></ul><h3>Global</h3><ul><li><a href="global.html#BAHN:UPDATE">BAHN:UPDATE</a></li><li><a href="global.html#comparePassword">comparePassword</a></li><li><a href="global.html#COVID:UPDATE">COVID:UPDATE</a></li><li><a href="global.html#hashPassword">hashPassword</a></li><li><a href="global.html#hashPasswordSync">hashPasswordSync</a></li><li><a href="global.html#HOMEKIT:SET-INITIALIZED">HOMEKIT:SET-INITIALIZED</a></li><li><a href="global.html#HOMEKIT:SET-SERVICES">HOMEKIT:SET-SERVICES</a></li><li><a href="global.html#LAYOUT:RESET">LAYOUT:RESET</a></li><li><a href="global.html#LAYOUT:UPDATE">LAYOUT:UPDATE</a></li><li><a href="global.html#NOTIFICATIONS:CREATE">NOTIFICATIONS:CREATE</a></li><li><a href="global.html#NOTIFICATIONS:DELETE">NOTIFICATIONS:DELETE</a></li><li><a href="global.html#NOTIFICATIONS:MARK-AS-READ">NOTIFICATIONS:MARK-AS-READ</a></li><li><a href="global.html#NOTIFICATIONS:SET">NOTIFICATIONS:SET</a></li><li><a href="global.html#PLUGINS:ADD">PLUGINS:ADD</a></li><li><a href="global.html#SPOTIFY:UPDATE-TOKEN">SPOTIFY:UPDATE-TOKEN</a></li><li><a href="global.html#SYSTEM-INFO:UPDATE">SYSTEM-INFO:UPDATE</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Sat Apr 24 2021 01:53:25 GMT+0200 (Mitteleurop√§ische Sommerzeit)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
