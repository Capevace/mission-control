<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Module: @state</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Module: @state</h1>

    




<section>

<header>
    
        
            
        
            
        
    
</header>

<article>
    <div class="container-overview">
    
        
            <div class="description"><h3>The State Machine, heart and soul of mission control.</h3>
<p>The state maching is responsible for keeping the state for lights etc.
It works in a similar way that React/Redux works. But its simplified in that
reducers and actions are basically merged.
We have a store that holds all the data. This store is immutable.
To update data in the store, we need to define actions.
The actions will take the old state, and create a new one with updated data.
When an action is run / data is updated, the state machine's event emitter
sends a trigger that data has changed.
This will be broadcasted to internal services inside mission control or through
a Node-RED component. Node-RED flows can then update accordingly.</p>
<p>This means, that the state machine resembles the SSOT (single source of truth).</p>
<p>You can subscribe to specific data points in the state machine e.g.:
This will only trigger when any data within the lights.desk object changes.</p>
<p>Action names are always all caps to reduce errors when calling them.
An action cannot have side effects. HTTP requests and similar async tasks
are handled outside the state machine, to reduce complexity.</p></div>
        

        
            















<dl class="details">

    

    
    <dt class="tag-since">Since:</dt>
    <dd class="tag-since"><ul class="dummy"><li>1.0.0</li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    
    <dt class="tag-source">Source:</dt>
    <dd class="tag-source"><ul class="dummy"><li>
        <a href="state_index.js.html">state/index.js</a>, <a href="state_index.js.html#line1">line 1</a>
    </li></ul></dd>
    

    

    

    
</dl>



















    <h5>Examples</h5>
    
    <pre class="prettyprint"><code>state.subscribe('update:lights.desk')
state.subscribe('action:ACTION_NAME')</code></pre>

    <pre class="prettyprint"><code>function ACTION(oldState, actionData) {
    return Object.extend({}, oldState, { lampOn: actionData.isOn });
}</code></pre>



        
            















<dl class="details">

    

    
    <dt class="tag-since">Since:</dt>
    <dd class="tag-since"><ul class="dummy"><li>1.0.0</li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    
    <dt class="tag-source">Source:</dt>
    <dd class="tag-source"><ul class="dummy"><li>
        <a href="sync_index.js.html">sync/index.js</a>, <a href="sync_index.js.html#line1">line 1</a>
    </li></ul></dd>
    

    

    

    
</dl>



















    <h5>Examples</h5>
    
    <pre class="prettyprint"><code>state.subscribe('update:lights.desk')
state.subscribe('action:ACTION_NAME')</code></pre>

    <pre class="prettyprint"><code>function ACTION(oldState, actionData) {
    return Object.extend({}, oldState, { lampOn: actionData.isOn });
}</code></pre>



        
    
    </div>

    

    
        <h3 class="subsection-title">Requires</h3>

        <ul>
            <li>module:eventemitter2</li>
        
            <li>module:object-diff</li>
        
            <li><a href="module-@state_initial-state.html">module:@state/initial-state</a></li>
        </ul>
    

    

    

    

    

    

    
        <h3 class="subsection-title">Methods</h3>

        
            

    

    
    <h4 class="name" id="~emitEvent"><span class="type-signature">(inner) </span>emitEvent<span class="signature">(event, data)</span><span class="type-signature"></span></h4>
    

    



<div class="description">
    <p>Emit an event to the state machine message bus.</p>
</div>









    <h5>Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>event</code></td>
            

            <td class="type">
            
                
<span class="param-type">String</span>


            
            </td>

            

            

            <td class="description last"><p>The event type to be emitted.</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>data</code></td>
            

            <td class="type">
            
                
<span class="param-type">Object</span>


            
            </td>

            

            

            <td class="description last"><p>The data to be emitted as a payload.</p></td>
        </tr>

    
    </tbody>
</table>






<dl class="details">

    

    

    

    

    

    

    

    

    

    

    

    

    
    <dt class="tag-source">Source:</dt>
    <dd class="tag-source"><ul class="dummy"><li>
        <a href="state_index.js.html">state/index.js</a>, <a href="state_index.js.html#line182">line 182</a>
    </li></ul></dd>
    

    

    

    
</dl>




















        
            

    

    
    <h4 class="name" id="~getState"><span class="type-signature">(inner) </span>getState<span class="signature">()</span><span class="type-signature"> &rarr; {Object}</span></h4>
    

    



<div class="description">
    <p>Get the current state of the state machine.</p>
</div>













<dl class="details">

    

    

    

    

    

    

    

    

    

    

    

    

    
    <dt class="tag-source">Source:</dt>
    <dd class="tag-source"><ul class="dummy"><li>
        <a href="state_index.js.html">state/index.js</a>, <a href="state_index.js.html#line190">line 190</a>
    </li></ul></dd>
    

    

    

    
</dl>















<h5>Returns:</h5>

        


<dl>
    <dt>
        Type
    </dt>
    <dd>
        
<span class="param-type">Object</span>


    </dd>
</dl>

    





        
            

    

    
    <h4 class="name" id="~invokeAction"><span class="type-signature">(inner) </span>invokeAction<span class="signature">(actionKey, data)</span><span class="type-signature"></span></h4>
    

    



<div class="description">
    <p>Evoke an action.</p>
<p>This method will run an action on the state machine.
Every action has a function and a validator.
This function first runs the validator to see if the incoming data is valid
and then executed the action function.</p>
</div>









    <h5>Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>actionKey</code></td>
            

            <td class="type">
            
                
<span class="param-type">String</span>


            
            </td>

            

            

            <td class="description last"><p>The action to evoke.</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>data</code></td>
            

            <td class="type">
            
                
<span class="param-type">Object</span>


            
            </td>

            

            

            <td class="description last"><p>The data object to pass along to the action reducer/handler.</p></td>
        </tr>

    
    </tbody>
</table>






<dl class="details">

    

    

    

    

    

    

    

    

    

    

    

    

    
    <dt class="tag-source">Source:</dt>
    <dd class="tag-source"><ul class="dummy"><li>
        <a href="state_index.js.html">state/index.js</a>, <a href="state_index.js.html#line109">line 109</a>
    </li></ul></dd>
    

    

    

    
</dl>





<h5>Fires:</h5>
<ul>
    <li>event:'update'</li>
</ul>
















        
            

    

    
    <h4 class="name" id="~registerReducer"><span class="type-signature">(inner) </span>registerReducer<span class="signature">(action, reducer, validate)</span><span class="type-signature"></span></h4>
    

    



<div class="description">
    <p>Register a reducer for a given state action</p>
</div>









    <h5>Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>action</code></td>
            

            <td class="type">
            
                
<span class="param-type">string</span>


            
            </td>

            

            

            <td class="description last"><p>The action to register a reducer for</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>reducer</code></td>
            

            <td class="type">
            
                
<span class="param-type">function</span>


            
            </td>

            

            

            <td class="description last"><p>The reducer function</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>validate</code></td>
            

            <td class="type">
            
                
<span class="param-type">function</span>


            
            </td>

            

            

            <td class="description last"><p>The data validation function</p></td>
        </tr>

    
    </tbody>
</table>






<dl class="details">

    

    

    

    

    

    

    

    

    

    

    

    

    
    <dt class="tag-source">Source:</dt>
    <dd class="tag-source"><ul class="dummy"><li>
        <a href="state_index.js.html">state/index.js</a>, <a href="state_index.js.html#line60">line 60</a>
    </li></ul></dd>
    

    

    

    
</dl>




















        
            

    

    
    <h4 class="name" id="~subscribe"><span class="type-signature">(inner) </span>subscribe<span class="signature">(event, callback)</span><span class="type-signature"> &rarr; {function}</span></h4>
    

    



<div class="description">
    <p>Subscribe to mission control events.</p>
<p>This function is used to subscribe to any event within the server.
If the passed event is '*' the listener will be subscribed to all events.</p>
</div>









    <h5>Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>event</code></td>
            

            <td class="type">
            
                
<span class="param-type">String</span>


            
            </td>

            

            

            <td class="description last"><p>The event to subscribe to. Can be '*' to subscribe to all events.</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>callback</code></td>
            

            <td class="type">
            
                
<span class="param-type">function</span>


            
            </td>

            

            

            <td class="description last"><p>The callback / listener function.</p></td>
        </tr>

    
    </tbody>
</table>






<dl class="details">

    

    

    

    

    

    

    

    

    

    

    

    

    
    <dt class="tag-source">Source:</dt>
    <dd class="tag-source"><ul class="dummy"><li>
        <a href="state_index.js.html">state/index.js</a>, <a href="state_index.js.html#line77">line 77</a>
    </li></ul></dd>
    

    

    

    
</dl>















<h5>Returns:</h5>

        
<div class="param-desc">
    <p>A function to remove the listener when called.</p>
</div>



<dl>
    <dt>
        Type
    </dt>
    <dd>
        
<span class="param-type">function</span>


    </dd>
</dl>

    





        
    

    

    
</article>

</section>







<section>

<header>
    
        
            
        
            
        
    
</header>

<article>
    <div class="container-overview">
    
        
            <div class="description"><h3>Sync – The heart of mission-control</h3>
<p>Sync is the main logic of mission control. It hosts the global event loop and
is responsible for managing state and synchronising it with connected clients.
The state can include like system information, HomeKit devices or anything
plugins wish to make available to all clients.</p>
<p>The event loop holds two types of event:</p>
<ul>
<li>base-event
<ul>
<li>request</li>
</ul>
</li>
</ul>
<p>A base-event handles like any other event.
It will be called but won't want any response back.
Event handlers will be called asynchronously and no error is thrown if an
event doesn't have a listener.</p>
<p>A request is an event that will expect a response.
If no event handler can be found or an error occurs in one of them,
the response will be an error object which clients can handle accordingly.</p>
<p><strong>Note</strong>: the sync engine does NOT send request events to other clients.
These events get filtered out, so request information leaks.
However, all base-events are broadcasted to all connected clients.</p>
<p>When the State is changed, a <code>state:updated</code> base-event is dispatched,
with the changed state inside.
<strong>Note</strong>: There currently is no validation in state updates to detect data corruption
for example by events arriving out of sync. So far this has not led to any problems,
but these could definitely occur if enough users or actions get executed silmutaneously.
This should be looked at in the future @todo.</p>
<p>To change the state, a <code>setState</code> function is exposed which is a bit like React's.
It takes one argument, the updated state, and will run <code>Object.assign</code> to the current
state to only update changed values.
<strong>Note</strong>: Bear in mind, that this only works one level deep.</p>
<p>So you'll still need to do this:</p>
<pre class="prettyprint source lang-js"><code>setState({
		myPlugin: {
			...myPlugin,
			change: 'bla'
		}
});
</code></pre></div>
        

        
            















<dl class="details">

    

    
    <dt class="tag-since">Since:</dt>
    <dd class="tag-since"><ul class="dummy"><li>1.0.0</li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    
    <dt class="tag-source">Source:</dt>
    <dd class="tag-source"><ul class="dummy"><li>
        <a href="state_index.js.html">state/index.js</a>, <a href="state_index.js.html#line1">line 1</a>
    </li></ul></dd>
    

    

    

    
</dl>



















    <h5>Examples</h5>
    
    <pre class="prettyprint"><code>state.subscribe('update:lights.desk')
state.subscribe('action:ACTION_NAME')</code></pre>

    <pre class="prettyprint"><code>function ACTION(oldState, actionData) {
    return Object.extend({}, oldState, { lampOn: actionData.isOn });
}</code></pre>



        
            















<dl class="details">

    

    
    <dt class="tag-since">Since:</dt>
    <dd class="tag-since"><ul class="dummy"><li>1.0.0</li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    
    <dt class="tag-source">Source:</dt>
    <dd class="tag-source"><ul class="dummy"><li>
        <a href="sync_index.js.html">sync/index.js</a>, <a href="sync_index.js.html#line1">line 1</a>
    </li></ul></dd>
    

    

    

    
</dl>



















    <h5>Examples</h5>
    
    <pre class="prettyprint"><code>state.subscribe('update:lights.desk')
state.subscribe('action:ACTION_NAME')</code></pre>

    <pre class="prettyprint"><code>function ACTION(oldState, actionData) {
    return Object.extend({}, oldState, { lampOn: actionData.isOn });
}</code></pre>



        
    
    </div>

    

    
        <h3 class="subsection-title">Requires</h3>

        <ul>
            <li>module:eventemitter2</li>
        
            <li>module:object-diff</li>
        
            <li><a href="module-@state_initial-state.html">module:@state/initial-state</a></li>
        </ul>
    

    

    

    

    

    

    
        <h3 class="subsection-title">Methods</h3>

        
            

    

    
    <h4 class="name" id="~emitEvent"><span class="type-signature">(inner) </span>emitEvent<span class="signature">(event, data)</span><span class="type-signature"></span></h4>
    

    



<div class="description">
    <p>Emit an event to the state machine message bus.</p>
</div>









    <h5>Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>event</code></td>
            

            <td class="type">
            
                
<span class="param-type">String</span>


            
            </td>

            

            

            <td class="description last"><p>The event type to be emitted.</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>data</code></td>
            

            <td class="type">
            
                
<span class="param-type">Object</span>


            
            </td>

            

            

            <td class="description last"><p>The data to be emitted as a payload.</p></td>
        </tr>

    
    </tbody>
</table>






<dl class="details">

    

    

    

    

    

    

    

    

    

    

    

    

    
    <dt class="tag-source">Source:</dt>
    <dd class="tag-source"><ul class="dummy"><li>
        <a href="state_index.js.html">state/index.js</a>, <a href="state_index.js.html#line182">line 182</a>
    </li></ul></dd>
    

    

    

    
</dl>




















        
            

    

    
    <h4 class="name" id="~getState"><span class="type-signature">(inner) </span>getState<span class="signature">()</span><span class="type-signature"> &rarr; {Object}</span></h4>
    

    



<div class="description">
    <p>Get the current state of the state machine.</p>
</div>













<dl class="details">

    

    

    

    

    

    

    

    

    

    

    

    

    
    <dt class="tag-source">Source:</dt>
    <dd class="tag-source"><ul class="dummy"><li>
        <a href="state_index.js.html">state/index.js</a>, <a href="state_index.js.html#line190">line 190</a>
    </li></ul></dd>
    

    

    

    
</dl>















<h5>Returns:</h5>

        


<dl>
    <dt>
        Type
    </dt>
    <dd>
        
<span class="param-type">Object</span>


    </dd>
</dl>

    





        
            

    

    
    <h4 class="name" id="~invokeAction"><span class="type-signature">(inner) </span>invokeAction<span class="signature">(actionKey, data)</span><span class="type-signature"></span></h4>
    

    



<div class="description">
    <p>Evoke an action.</p>
<p>This method will run an action on the state machine.
Every action has a function and a validator.
This function first runs the validator to see if the incoming data is valid
and then executed the action function.</p>
</div>









    <h5>Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>actionKey</code></td>
            

            <td class="type">
            
                
<span class="param-type">String</span>


            
            </td>

            

            

            <td class="description last"><p>The action to evoke.</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>data</code></td>
            

            <td class="type">
            
                
<span class="param-type">Object</span>


            
            </td>

            

            

            <td class="description last"><p>The data object to pass along to the action reducer/handler.</p></td>
        </tr>

    
    </tbody>
</table>






<dl class="details">

    

    

    

    

    

    

    

    

    

    

    

    

    
    <dt class="tag-source">Source:</dt>
    <dd class="tag-source"><ul class="dummy"><li>
        <a href="state_index.js.html">state/index.js</a>, <a href="state_index.js.html#line109">line 109</a>
    </li></ul></dd>
    

    

    

    
</dl>





<h5>Fires:</h5>
<ul>
    <li>event:'update'</li>
</ul>
















        
            

    

    
    <h4 class="name" id="~registerReducer"><span class="type-signature">(inner) </span>registerReducer<span class="signature">(action, reducer, validate)</span><span class="type-signature"></span></h4>
    

    



<div class="description">
    <p>Register a reducer for a given state action</p>
</div>









    <h5>Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>action</code></td>
            

            <td class="type">
            
                
<span class="param-type">string</span>


            
            </td>

            

            

            <td class="description last"><p>The action to register a reducer for</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>reducer</code></td>
            

            <td class="type">
            
                
<span class="param-type">function</span>


            
            </td>

            

            

            <td class="description last"><p>The reducer function</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>validate</code></td>
            

            <td class="type">
            
                
<span class="param-type">function</span>


            
            </td>

            

            

            <td class="description last"><p>The data validation function</p></td>
        </tr>

    
    </tbody>
</table>






<dl class="details">

    

    

    

    

    

    

    

    

    

    

    

    

    
    <dt class="tag-source">Source:</dt>
    <dd class="tag-source"><ul class="dummy"><li>
        <a href="state_index.js.html">state/index.js</a>, <a href="state_index.js.html#line60">line 60</a>
    </li></ul></dd>
    

    

    

    
</dl>




















        
            

    

    
    <h4 class="name" id="~subscribe"><span class="type-signature">(inner) </span>subscribe<span class="signature">(event, callback)</span><span class="type-signature"> &rarr; {function}</span></h4>
    

    



<div class="description">
    <p>Subscribe to mission control events.</p>
<p>This function is used to subscribe to any event within the server.
If the passed event is '*' the listener will be subscribed to all events.</p>
</div>









    <h5>Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>event</code></td>
            

            <td class="type">
            
                
<span class="param-type">String</span>


            
            </td>

            

            

            <td class="description last"><p>The event to subscribe to. Can be '*' to subscribe to all events.</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>callback</code></td>
            

            <td class="type">
            
                
<span class="param-type">function</span>


            
            </td>

            

            

            <td class="description last"><p>The callback / listener function.</p></td>
        </tr>

    
    </tbody>
</table>






<dl class="details">

    

    

    

    

    

    

    

    

    

    

    

    

    
    <dt class="tag-source">Source:</dt>
    <dd class="tag-source"><ul class="dummy"><li>
        <a href="state_index.js.html">state/index.js</a>, <a href="state_index.js.html#line77">line 77</a>
    </li></ul></dd>
    

    

    

    
</dl>















<h5>Returns:</h5>

        
<div class="param-desc">
    <p>A function to remove the listener when called.</p>
</div>



<dl>
    <dt>
        Type
    </dt>
    <dd>
        
<span class="param-type">function</span>


    </dd>
</dl>

    





        
    

    

    
</article>

</section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-@config.html">@config</a></li><li><a href="module-@database.html">@database</a></li><li><a href="module-@helpers_log.html">@helpers/log</a></li><li><a href="module-@http.html">@http</a></li><li><a href="module-@socket.html">@socket</a></li><li><a href="module-@state.html">@state</a></li><li><a href="module-@state_actions.html">@state/actions</a></li><li><a href="module-@state_initial-state.html">@state/initial-state</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-test.html">test</a></li></ul><h3>Global</h3><ul><li><a href="global.html#BAHN:UPDATE">BAHN:UPDATE</a></li><li><a href="global.html#comparePassword">comparePassword</a></li><li><a href="global.html#COVID:UPDATE">COVID:UPDATE</a></li><li><a href="global.html#hashPassword">hashPassword</a></li><li><a href="global.html#hashPasswordSync">hashPasswordSync</a></li><li><a href="global.html#HOMEKIT:SET-INITIALIZED">HOMEKIT:SET-INITIALIZED</a></li><li><a href="global.html#HOMEKIT:SET-SERVICES">HOMEKIT:SET-SERVICES</a></li><li><a href="global.html#LAYOUT:RESET">LAYOUT:RESET</a></li><li><a href="global.html#LAYOUT:UPDATE">LAYOUT:UPDATE</a></li><li><a href="global.html#NOTIFICATIONS:CREATE">NOTIFICATIONS:CREATE</a></li><li><a href="global.html#NOTIFICATIONS:DELETE">NOTIFICATIONS:DELETE</a></li><li><a href="global.html#NOTIFICATIONS:MARK-AS-READ">NOTIFICATIONS:MARK-AS-READ</a></li><li><a href="global.html#NOTIFICATIONS:SET">NOTIFICATIONS:SET</a></li><li><a href="global.html#PLUGINS:ADD">PLUGINS:ADD</a></li><li><a href="global.html#SPOTIFY:UPDATE-TOKEN">SPOTIFY:UPDATE-TOKEN</a></li><li><a href="global.html#SYSTEM-INFO:UPDATE">SYSTEM-INFO:UPDATE</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Sat Apr 24 2021 01:53:25 GMT+0200 (Mitteleuropäische Sommerzeit)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>