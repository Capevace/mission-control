<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: plugins/internal/homekit/index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: plugins/internal/homekit/index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const { HapClient } = require('@oznu/hap-client');

module.exports = function homekitInit(APP) {
	const { state, logger, config, http } = APP;

	/**
	 * @ACTION
	 * @TODO Turn this into an EVENT

	 * This is supposed to be a no op action because 
	 * we still have to register it with the state system.
	 */
	state.addAction(
		'HOMEKIT:MODIFY-CHARACTERISTICS', 
		(state) => {
			return {
				...state
			};
		},
		(data) => data
	);

	/**
	 * @ACTION
	 * Set homebridge config initialization state to indicate wether the pin is configured.
	 *
	 * @constant HOMEKIT:SET-INITIALIZED
	 * @property {Boolean} initialized 
	 * @example
	 * state.invoke('HOMEKIT:SET-INITIALIZED', { initialized: false })
	 */
	state.addAction(
		'HOMEKIT:SET-INITIALIZED', 
		(state, { initialized = false }) => {
			return {
				...state,
				homekit: {
					initialized: !!initialized
				}
			};
		},
		(data) => data
	);

	/**
	 * @ACTION
	 * Set the devices homebridge sees
	 *
	 * @constant HOMEKIT:SET-SERVICES
	 * @property {Object} service The video object to push onto the queue.
	 * @property {string} service.uniqueId A unique ID for the service.
	 * @property {number} service.iid A unique ID for the service (used for identification internally).
	 * @property {string} service.name Name of the service
	 * @property {string} service.type Type of the service
	 * @property {Array} service.characteristics Array of characteristics
	 * @property {Array} service.values Array of values for the characteristics
	 * @example
	 * state.invoke('HOMEKIT:SET-SERVICES', { services: { 'serviceID': { ...service }}})
	 */
	state.addAction(
		'HOMEKIT:SET-SERVICES', 
		(state, { services = {}, reset = false }) => {
			/*
				Service: {
					uniqueId: string,
					iid: string,
					name: string,
					type: 'Switch',
					characteristics: [{}],
					values: []
				}
			*/

			const value = reset ? services : { ...state.homekit.services, ...services };

			return {
				...state,
				homekit: {
					...state.homekit,
					services: value
				}
			};
		},
		(data) => {
			const allItemsComplete = Object.values(data.services)
				.filter(
					service =>
						service.uniqueId
						&amp;&amp; service.iid
						&amp;&amp; service.name
						&amp;&amp; service.type
						&amp;&amp; Array.isArray(service.characteristics)
						&amp;&amp; Array.isArray(service.values)
				).length > 0;

			if (data.services &amp;&amp; !allItemsComplete) {
				return data;
			}

			return false;
		}
	);

	http.addComponentFile('homekitSwitches', __dirname + '/component.html');


	if (!config.homebridge.pin) {
		logger.warn(
			'Won\'t be able to connect to Homebridge, as the secret pin is not defined in config file.'
		);
		state.invoke('HOMEKIT:SET-INITIALIZED', { initialized: false });
		return;
	}

	const hap = new HapClient({
		pin: config.homebridge.pin,
		logger: {
			log: logger.debug,
			info: logger.debug,
			error: logger.error,
			warning: logger.warn,
			verbose: logger.debug
		},
		config: {
			debug: true
		},
	});

	// TODO: Error detection for homebridge connection or something. I do
	// think that HapClient does error logging on its own but ¯\_(ツ)_/¯
	state.invoke('HOMEKIT:SET-INITIALIZED', { initialized: true });

	let monitor = null;

	hap.on('instance-discovered', async () => {
		logger.debug('Discovered new HAP instance');
		const servicesList = await hap.getAllServices();

		let servicesData = {};
		for (const service of servicesList) {
			// servicesActions[service.uniqueId] = {
			// 	getCharacteristic: service.getCharacteristic
			// };

			servicesData[service.uniqueId] = simplifyService(service);
		}

		state.invoke(
			'HOMEKIT:SET-SERVICES',
			{
				services: servicesData,
				reset: true
			}
		);

		if (monitor) {
			monitor.finish();
			monitor = null;
		}

		// Setup monitoring of characteristics to detect changes
		monitor = await hap.monitorCharacteristics();
		const updateHandler = (data) => {
			logger.debug('Received characteristics update', data);

			let servicesData = {};
			for (const service of data) {
				servicesData[service.uniqueId] = simplifyService(service);
			}

			state.invoke(
				'HOMEKIT:SET-SERVICES',
				{
					services: servicesData
				}
			);
		};
		monitor.on('service-update', updateHandler);
	});

	state.subscribe('action:HOMEKIT:MODIFY-CHARACTERISTICS', async (context) => {
		const { uniqueId, changes = {} } = context.actionData;

		logger.debug(`Modifying characteristics in service ${uniqueId} with changes ${JSON.stringify(changes, null, 2)}`);

		const services = await hap.getAllServices();
		const service = services.find(service => service.uniqueId === uniqueId);
		if (!service) {
			logger.error(`Could not find service with id: ${uniqueId}`);
			return;
		}

		for (const characteristicName in changes) {
			const newValue = changes[characteristicName];

			const characteristic = service.getCharacteristic(characteristicName);

			if (!characteristic || !characteristic.setValue) {
				logger.error(`Could not find characteristic with name: ${characteristicName}`);
				continue;
			}

			characteristic.setValue(newValue);
		}
	});

	return {
		author: 'Lukas Mateffy (@capevace)',
		version: '0.0.1',
		description: 'HomeKit switch bridge'
	};
};

function simplifyService(inputService) {
	return {
		uniqueId: inputService.uniqueId,
		iid: inputService.iid,
		name: inputService.serviceName,
		type: inputService.type,
		characteristics: inputService.serviceCharacteristics,
		values: inputService.values
	};
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-@config.html">@config</a></li><li><a href="module-@database.html">@database</a></li><li><a href="module-@helpers_log.html">@helpers/log</a></li><li><a href="module-@http.html">@http</a></li><li><a href="module-@socket.html">@socket</a></li><li><a href="module-@state.html">@state</a></li><li><a href="module-@state_actions.html">@state/actions</a></li><li><a href="module-@state_initial-state.html">@state/initial-state</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-test.html">test</a></li></ul><h3>Global</h3><ul><li><a href="global.html#BAHN:UPDATE">BAHN:UPDATE</a></li><li><a href="global.html#comparePassword">comparePassword</a></li><li><a href="global.html#COVID:UPDATE">COVID:UPDATE</a></li><li><a href="global.html#hashPassword">hashPassword</a></li><li><a href="global.html#hashPasswordSync">hashPasswordSync</a></li><li><a href="global.html#HOMEKIT:SET-INITIALIZED">HOMEKIT:SET-INITIALIZED</a></li><li><a href="global.html#HOMEKIT:SET-SERVICES">HOMEKIT:SET-SERVICES</a></li><li><a href="global.html#LAYOUT:RESET">LAYOUT:RESET</a></li><li><a href="global.html#LAYOUT:UPDATE">LAYOUT:UPDATE</a></li><li><a href="global.html#NOTIFICATIONS:CREATE">NOTIFICATIONS:CREATE</a></li><li><a href="global.html#NOTIFICATIONS:DELETE">NOTIFICATIONS:DELETE</a></li><li><a href="global.html#NOTIFICATIONS:MARK-AS-READ">NOTIFICATIONS:MARK-AS-READ</a></li><li><a href="global.html#NOTIFICATIONS:SET">NOTIFICATIONS:SET</a></li><li><a href="global.html#PLUGINS:ADD">PLUGINS:ADD</a></li><li><a href="global.html#SPOTIFY:UPDATE-TOKEN">SPOTIFY:UPDATE-TOKEN</a></li><li><a href="global.html#SYSTEM-INFO:UPDATE">SYSTEM-INFO:UPDATE</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Sat Apr 24 2021 01:53:25 GMT+0200 (Mitteleuropäische Sommerzeit)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
