
<script>
    const leftPad = MISSION_CONTROL.utils.leftPad;

    function dateToTime(date, onlyMinutes = false) {
        const hours = leftPad(date.getHours(), 2, '0');
        const minutes = leftPad(date.getMinutes(), 2, '0');

        return onlyMinutes
            ? minutes
            : `${hours}:${minutes}`;
    }

    const busRow = {
        props: {
            bus: {
                type: Object,
                default: {
                    name: 'Test Bahn',
                    departure: new Date(),
                    arrival: new Date()
                },
                required: true
            },
            index: {
                type: Number,
                default: 0
            }
        },
        template: `
            <div class="text-left transition">
                <div class="text-purple-50 align-middle">{{bus.name}}</div>
                <span class="text-purple-400 font-mono align-middle">{{bus.departure | dateify}}-:{{bus.arrival | minutify}}</span>
            </div>
        `,
        methods: {
            animationDelay() {
                return {
                    animationDelay: (this.index * this.index / 2 * 20) + 'ms'
                };
            }
        },
        filters: {
            dateify(value) {
                return dateToTime(new Date(value));
            },

            minutify(value) {
                return dateToTime(new Date(value), true);
            }
        }
    };

    const bahnRow = {
        props: {
            route: {
                type: Object,
                required: true
            }
        },
        data: () => ({
            expanded: false
        }),
        template: `
            <div
                class="list-reset flex cursor-pointer flex-wrap"
                @click="expanded = !expanded"
            >
                <div class="flex-shrink-0 flex flex-col justify-start font-semibold mr-4 mb-2">
                    <div class="text-xl text-purple-50 leading-tight">
                        {{route.departure | dateify}}<span v-if="route.departureDelay">{{route.departureDelay}}</span>
                        –
                        {{route.arrival | dateify}}<span v-if="route.arrivalDelay">{{route.arrivalDelay}}</span>
                    </div>
                    <div class="text-sm text-purple-400">
                        {{route.lines}}
                    </div>
                </div>

                <div class="flex-1 flex">
                    <div class="flex-1 flex flex-wrap overflow-hidden" :class="{ 'h-auto': expanded, 'h-9': !expanded }">
                        <bus-row
                            v-if="route.buses && route.buses.length > 0"
                            v-for="(bus, index) in route.buses"
                            :bus="bus"
                            :visible="true"
                            :index="index"
                            class="text-xs mr-3 mb-3"
                        />

                        <div v-else class="text-sm text-main-lighter">No busses found</div>
                    </div>
                    <div class="w-2 text-xs font-mono font-semibold text-purple-400" v-if="route.buses && route.buses.length > 0">
                        {{ route.buses.length }}
                    </div>
                </div>
            </div>
        `,
        filters: {
            dateify(value) {
                return dateToTime(new Date(value));
            }
        },
        components: {
            busRow
        }
    }

    MISSION_CONTROL.dashboard.component('bahn', {
        template: `
            <section class="w-full h-full">
                <div class="dashboard-box-heading mb-3 ">Trains to Lübeck Hbf</div>
                <div class="dashboard-box w-full flex flex-col justify-start pr-3">
                    <div class="list-none p-0 w-full text-main-lightest inline-block overflow-y-scroll h-full">
                        <bahn-row
                            v-for="(route, index) in bahnState.routes"
                            :route="route"
                            :class="{ 'mb-4': index !== bahnState.routes.length - 1 }"
                        />
                    </div>
                </div>
            </section>
        `,
        computed: {
            bahnState() {
                return this.$mcState('bahn', {
                    routes: []
                });
            }
        },
        components: {
            bahnRow
        }
    })
</script>
