<!DOCTYPE html><html class="dark no-js"><head><meta charset="utf-8"><meta content="ie=edge" http-equiv="x-ua-compatible"><meta content="width=device-width,initial-scale=1" name="viewport"><base data-ice="baseUrl" href="../../../"><title data-ice="title">app/helpers/logger.js | Mission Control</title><script src="script/search_index.js"></script><link href="css/2f0514c18c642778d627.css" rel="stylesheet"><meta name="description" content="Beautiful smart home dashboard software built on Node.js"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="Mission Control"><meta property="twitter:description" content="Beautiful smart home dashboard software built on Node.js"></head><body class="layout-container" data-ice="rootContainer"><header class="js_mainHeader main-header"><div class="menu-switch"><a href="#" class="switch js_menuSwitch menu-switch"><span class="icon menu-icon"><svg viewbox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z"/></svg></span></a></div><nav class="main-nav"><a href="./" class="link link-to-home" style="display: flex; align-items: center;"><img src="./image/brand_logo.png" style="width:34px;"></a><a href="./manual/index.html" class="link link-to-manual" data-ice="manualHeaderLink"><span class="icon link-icon manual-icon"><svg viewbox="0 0 24 24"><path d="M12,3L1,9L12,15L21,10.09V17H23V9M5,13.18V17.18L12,21L19,17.18V13.18L12,17L5,13.18Z"/></svg> </span><span class="link-text">Manual</span> </a><a href="identifiers.html" class="link link-to-reference"><span class="icon link-icon reference-icon"><svg viewbox="0 0 24 24"><path d="M16,6H13V7.9H16C18.26,7.9 20.1,9.73 20.1,12A4.1,4.1 0 0,1 16,16.1H13V18H16A6,6 0 0,0 22,12C22,8.68 19.31,6 16,6M3.9,12C3.9,9.73 5.74,7.9 8,7.9H11V6H8A6,6 0 0,0 2,12A6,6 0 0,0 8,18H11V16.1H8C5.74,16.1 3.9,14.26 3.9,12M8,13H16V11H8V13Z"/></svg> </span><span class="link-text">Reference</span> </a><a href="source.html" class="link link-to-source"><span class="icon link-icon source-icon"><svg viewbox="0 0 24 24"><path d="M8,3A2,2 0 0,0 6,5V9A2,2 0 0,1 4,11H3V13H4A2,2 0 0,1 6,15V19A2,2 0 0,0 8,21H10V19H8V14A2,2 0 0,0 6,12A2,2 0 0,0 8,10V5H10V3M16,3A2,2 0 0,1 18,5V9A2,2 0 0,0 20,11H21V13H20A2,2 0 0,0 18,15V19A2,2 0 0,1 16,21H14V19H16V14A2,2 0 0,1 18,12A2,2 0 0,1 16,10V5H14V3H16Z"/></svg> </span><span class="link-text">Source</span> </a></nav><div class="js_searchBox search-box"><div class="js_searchInputWrapper search-input-wrapper"><span class="icon js_searchIcon search-icon"><svg viewbox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/></svg> </span><input class="js_searchInput search-input"></div><ul class="hidden js_searchResult search-result"></ul></div><div class="mode-switch"><a href="#" class="switch js_modeSwitch mode-switch"><span class="icon light-dark-icon"><svg viewbox="0 0 24 24"><path d="M7.5,2C5.71,3.15 4.5,5.18 4.5,7.5C4.5,9.82 5.71,11.85 7.53,13C4.46,13 2,10.54 2,7.5A5.5,5.5 0 0,1 7.5,2M19.07,3.5L20.5,4.93L4.93,20.5L3.5,19.07L19.07,3.5M12.89,5.93L11.41,5L9.97,6L10.39,4.3L9,3.24L10.75,3.12L11.33,1.47L12,3.1L13.73,3.13L12.38,4.26L12.89,5.93M9.59,9.54L8.43,8.81L7.31,9.59L7.65,8.27L6.56,7.44L7.92,7.35L8.37,6.06L8.88,7.33L10.24,7.36L9.19,8.23L9.59,9.54M19,13.5A5.5,5.5 0 0,1 13.5,19C12.28,19 11.15,18.6 10.24,17.93L17.93,10.24C18.6,11.15 19,12.28 19,13.5M14.6,20.08L17.37,18.93L17.13,22.28L14.6,20.08M18.93,17.38L20.08,14.61L22.28,17.15L18.93,17.38M20.08,12.42L18.94,9.64L22.28,9.88L20.08,12.42M9.63,18.93L12.4,20.08L9.87,22.27L9.63,18.93Z"/></svg></span></a></div><div class="settings-switch"><a href="#" class="switch js_settingsSwitch settings-switch"><span class="icon settings-icon"><svg viewbox="0 0 24 24"><path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/></svg></span></a></div><a style="position:relative; top:3px;" href="https://github.com/capevace/mission-control"><img width="20px" src="./image/github.png"></a></header><main class="main"><div class="content" data-ice="content"><h1 data-ice="title">app/helpers/logger.js</h1><pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * Logging Helpers
 * @module @helpers/log
 * @requires chalk, qrcode-terminal
 */

const chalk = require(&apos;chalk&apos;);
const qrcode = require(&apos;qrcode-terminal&apos;);
const onFinished = require(&apos;on-finished&apos;);
const cliProgress = require(&apos;cli-progress&apos;);

let logBuffer = [];
let progressBar = null;

const console_log = console.log.bind(console);

module.exports._log = function _log(...msgs) {
	if (progressBar)
		logBuffer.push(msgs);
	else
		console_log(...msgs); // eslint-disable-line
};

module.exports.newLine = function newLine() {
	module.exports._log(&apos;&apos;);
};

const LogLevel = {
	debug: 0,
	http: 1,
	info: 2,
	warn: 3,
	error: 4,
	fatal: 5,
	silent: 6
};
module.exports.LogLevel = LogLevel;


/**
 * Return a LogLevel from string.
 * @param {string} level 
 * @returns LogLevel | null
 */
module.exports.logLevelFromString = function logLevelFromString(level) {
	return LogLevel[level];
};

/**
 * Convert a LogLevel to string.
 * @param {LogLevel} logLevel 
 * @returns string | null
 */
module.exports.logLevelToString = function logLevelToString(logLevel) {
	let text = null;

	switch (logLevel) {
		case 0:
			text = chalk.green(&apos;DEBUG&apos;);
			break;
		case 1:
			text = chalk.magenta(&apos;HTTP&apos;);
			break;
		case 2:
			text = chalk.cyan(&apos;INFO&apos;);
			break;
		case 3:
			text = chalk.yellow(&apos;WARN&apos;);
			break;
		case 4:
			text = chalk.red(&apos;ERROR&apos;);
			break;
		case 5:
			text = chalk.red.bgBlack(&apos;FATAL&apos;);
			break;
		case 6:
			text = chalk.white.bgBlack(&apos;SILENT&apos;);
			break;
	}

	return text;
};

/**
 * Create a log function with a LogLevel label attached.
 * @param {LogLevel} levelOfLogger
 * @returns Function
 */
function createLogFunction(levelOfLogger) {
	const label = module.exports.logLevelToString(levelOfLogger);

	return function log(...msgs) {
		if (logLevel &lt;= levelOfLogger)
			module.exports._log(/*formatISO(new Date()),*/ label, ...msgs);
	};
}

/**
 * The global log level.
 */
let logLevel = LogLevel.http;

/*
 * The respective log functions.
 */
const debug = createLogFunction(LogLevel.debug);
const http = createLogFunction(LogLevel.http);
const info = createLogFunction(LogLevel.info);
const warn = createLogFunction(LogLevel.warn);
const error = createLogFunction(LogLevel.error);
const fatal = createLogFunction(LogLevel.fatal);

module.exports.debug = debug;
module.exports.http = http;
module.exports.info = info;
module.exports.warn = warn;
module.exports.error = error;
module.exports.fatal = fatal;


/**
 * Create a logger with text label attached.
 * @param {string} label
 * @param {string} color
 */
module.exports.createLogger = function createLogger(label, color = &apos;reset&apos;) {
	if (!label)
		return {
			newLine: module.exports.newLine,
			debug,
			http,
			info,
			warn,
			error,
			fatal
		};

	const colorFn = chalk[color];

	if (!colorFn)
		throw new Error(`Log color unsupported: ${color}`);

	label = colorFn(label);

	return {
		newLine: module.exports.newLine,
		debug: (...msgs) =&gt; debug(label, ...msgs),
		http: (...msgs) =&gt; http(label, ...msgs),
		info: (...msgs) =&gt; info(label, ...msgs),
		warn: (...msgs) =&gt; warn(label, ...msgs),
		error: (...msgs) =&gt; error(label, ...msgs),
		fatal: (...msgs) =&gt; fatal(label, ...msgs)
	};
};

/**
 * Set the global log level.
 * @param {LogLevel} level 
 */
module.exports.setLogLevel = function setLogLevel(levelString = &apos;debug&apos;) {
	if (!levelString)
		return;

	// If we can parse a log level from the logLevel config, then a string was passed and we can
	// parse the log level value.
	logLevel = this.logLevelFromString(levelString) || 0;
};

/**
 * Ouput the styled ready message including a QR code that leads to the base url.
 *
 * @param  {String} url - The url to encode and log.
 * @param  {String} authUrl - The auth url to display.
 */
module.exports.logReadyMessage = function logReadyMessage(url, authUrl) {
	qrcode.generate(url, { small: true }, function (qrCode) {
		const message =
			`
${`.  . .-. .-. .-. .-. .-. . .   .-. .-. . . .-. .-. .-. .   
|\\/|  |  \`-. \`-.  |  | | |\\|   |   | | |\\|  |  |(  | | |   
&apos;  &apos; &apos;-&apos; &apos;-&apos; &apos;-&apos; &apos;-&apos; &apos;-&apos; &apos; &apos;   &apos;-&apos; &apos;-&apos; &apos; &apos;  &apos;  &apos; &apos; &apos;-&apos; &apos;-&apos; `}

Mission Control available at ${chalk.cyan(url)}

${qrCode}
`;

		module.exports._log(message); // eslint-disable-line no-console
	});
};

module.exports.logMiddleware = function logMiddleware(req, res, next) {
	let startTime = process.hrtime();

	onFinished(res, () =&gt; {
		const colorFn = res.statusCode &gt;= 500 ? chalk.red // red
			: res.statusCode &gt;= 400 ? chalk.yellow // yellow
				: res.statusCode &gt;= 300 ? chalk.cyan // cyan
					: res.statusCode &gt;= 200 ? chalk.green // green
						: chalk.reset;

		const now = process.hrtime();
		const ms = (now[0] - startTime[0]) * 1e3 +
			(now[1] - startTime[1]) * 1e-6;

		http(req.method, req.url, colorFn(res.statusCode), `${ms.toFixed(3)}ms`);
	});

	next();
};

module.exports.logConfig = function logConfig(config) {
	const spotifyCredentialsPresent = config.spotify.clientId &amp;&amp; config.spotify.secret;
	
	module.exports._log(
		chalk`=== {bold Mission Control Config} ===
Version:		${config.version}
Log Level:		${config.logLevel}
DB Path:		{cyan ${config.databasePath}}
Dashboard Path: 	{cyan ${config.dashboard.path}}
Homebridge Pin:		${config.homebridge.pin || chalk.reset.gray(&apos;None&apos;)}
Spotify Creds:		${spotifyCredentialsPresent ? &apos;Provided&apos; : chalk.reset.gray(&apos;Not provided&apos;)}
HTTP URL:		{cyan ${config.http.url}}
HTTP Port:		${config.http.port}
HTTP Domains:		${config.http.allowedDomains.map(domain =&gt; chalk`{cyan ${domain}}`).join(&apos;, &apos;)}
\n`
	);
};

module.exports.progress = async function progress(callback) {
	progressBar = new cliProgress.SingleBar({
	    format: `|${chalk.cyan(&apos;{bar}&apos;)}| {percentage}% {label}`,
	    barCompleteChar: &apos;\u2588&apos;,
	    barIncompleteChar: &apos;\u2591&apos;,
	    hideCursor: true
	}, cliProgress.Presets.rect);

	progressBar.start(1, 0, {
	    label: &apos;&apos;
	});

	function cleanup() {
		if (progressBar) {
			progressBar.stop();
			progressBar = null;
		}

		logBuffer.forEach(msgs =&gt; console_log(...msgs));
		logBuffer = [];
	}

	try {
		await callback((label, percentage) =&gt; progressBar.update(percentage, { label }));
		cleanup();
	} catch (e) {
		cleanup();
		module.exports.error(e);
	}
};

process.on(&apos;uncaughtException&apos;, function (err) {
	error(chalk.red.bold(&apos;Uncaught Exception&apos;), err);
});</code></pre></div><footer class="main-footer"><img alt="esdoc logo" class="esdoc-logo" src="image/esdoc-logo-mini.png"> <span>Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span></a></span></footer></main><aside class="sidebar initial js_sidebarLeft sidebar-left" data-ice="nav"><nav class="nav"><ul class="nav-list"><li class="nav-item js_navItem _" data-ice="doc"><a class="nav-link js_dirPath _" data-ice="dirPath" href="identifiers.html#auth">auth</a><div class="hidden fake-nav-link js_fakeLink _"><span class="kind _kind-typedef" data-ice="kind">T</span> <span class="name _" data-ice="name"><span><a href="typedef/index.html#static-typedef-User">User</a></span></span></div></li>
<li class="nav-item js_navItem _" data-ice="doc"><a class="nav-link js_dirPath _" data-ice="dirPath" href="identifiers.html#plugins">plugins</a><div class="hidden fake-nav-link js_fakeLink _"><span class="kind _kind-typedef" data-ice="kind">T</span> <span class="name _" data-ice="name"><span><a href="typedef/index.html#static-typedef-HttpContext">HttpContext</a></span></span></div></li>
<li class="nav-item js_navItem _" data-ice="doc"><div class="hidden fake-nav-link js_fakeLink _"><span class="kind _kind-typedef" data-ice="kind">T</span> <span class="name _" data-ice="name"><span><a href="typedef/index.html#static-typedef-Plugin">Plugin</a></span></span></div></li>
<li class="nav-item js_navItem _" data-ice="doc"><div class="hidden fake-nav-link js_fakeLink _"><span class="kind _kind-typedef" data-ice="kind">T</span> <span class="name _" data-ice="name"><span><a href="typedef/index.html#static-typedef-PluginContext">PluginContext</a></span></span></div></li>
<li class="nav-item js_navItem _" data-ice="doc"><div class="hidden fake-nav-link js_fakeLink _"><span class="kind _kind-typedef" data-ice="kind">T</span> <span class="name _" data-ice="name"><span><a href="typedef/index.html#static-typedef-Router">Router</a></span></span></div></li>
<li class="nav-item js_navItem _" data-ice="doc"><a class="nav-link js_dirPath _" data-ice="dirPath" href="identifiers.html#plugins-internal">plugins/internal</a><div class="hidden fake-nav-link js_fakeLink _"><span class="kind _kind-typedef" data-ice="kind">T</span> <span class="name _" data-ice="name"><span><a href="typedef/index.html#static-typedef-Plugin">Plugin</a></span></span></div></li>
<li class="nav-item js_navItem _" data-ice="doc"><div class="hidden fake-nav-link js_fakeLink _"><span class="kind _kind-typedef" data-ice="kind">T</span> <span class="name _" data-ice="name"><span><a href="typedef/index.html#static-typedef-PluginContext">PluginContext</a></span></span></div></li>
<li class="nav-item js_navItem _" data-ice="doc"><div class="hidden fake-nav-link js_fakeLink _"><span class="kind _kind-typedef" data-ice="kind">T</span> <span class="name _" data-ice="name"><span><a href="typedef/index.html#static-typedef-PluginContext">PluginContext</a></span></span></div></li>
</ul></nav></aside><aside class="sidebar closed js_sidebarRight sidebar-right"><nav class="nav fonts-nav"><ul class="nav-list js_fontOptions"><li class="nav-item"><span class="headline nav-link">Main fonts</span></li></ul></nav><nav class="nav colorschemes-nav"><ul class="nav-list js_colorschemeOptions"><li class="nav-item"><span class="headline nav-link">Syntax themes</span></li></ul></nav></aside><script src="script/2f0514c18c642778d627.js"></script></body></html>